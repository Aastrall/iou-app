<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>IOU | Premium Social Finance</title>
    
    <link rel="apple-touch-icon" href="https://i.postimg.cc/8z9X689C/IOU-LOGO-CUSTOM.png">
    <link rel="icon" type="image/png" href="https://i.postimg.cc/8z9X689C/IOU-LOGO-CUSTOM.png">
    <link rel="manifest" href="manifest.json">
    
    <meta name="apple-mobile-web-app-title" content="IOU App">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-startup-image" href="https://i.postimg.cc/8z9X689C/IOU-LOGO-CUSTOM.png">

    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyC_O89rLpoYzVZ4ERKBmirOIGhOwwulCIs",
            authDomain: "iou-app-b7ed2.firebaseapp.com",
            databaseURL: "https://iou-app-b7ed2-default-rtdb.firebaseio.com",
            projectId: "iou-app-b7ed2",
            storageBucket: "iou-app-b7ed2.firebasestorage.app",
            messagingSenderId: "607906588480",
            appId: "1:607906588480:web:a64b8ca13884ef5582fca5"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();
    </script>

    <style>
        body { background-color: #000000; color: #39FF14; overflow-x: hidden; font-family: sans-serif; }
        .glass { background: rgba(57, 255, 20, 0.05); border: 1px solid rgba(57, 255, 20, 0.2); backdrop-filter: blur(10px); }
        .neo-btn { background-color: #39FF14; color: #000000; font-weight: 900; transition: all 0.3s; }
        .neo-btn:active { transform: scale(0.95); box-shadow: 0 0 20px #39FF14; }
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-10px); } 75% { transform: translateX(10px); } }
        .declined { animation: shake 0.4s ease-in-out; border-color: #ff4444 !important; }
        input { background: #111 !important; border: 1px solid #333 !important; color: #39FF14 !important; }
        ::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="min-h-screen">

    <div id="splashScreen" class="fixed inset-0 z-[5000] bg-black flex flex-col items-center justify-center transition-opacity duration-700">
        <img src="https://i.postimg.cc/8z9X689C/IOU-LOGO-CUSTOM.png" class="w-48 h-48 animate-pulse rounded-3xl">
        <p class="mt-6 text-[#39FF14] font-black tracking-[0.4em] animate-pulse text-xs">INITIALIZING SYSTEM</p>
    </div>

    <div id="authSection" class="fixed inset-0 z-[1000] bg-black flex items-center justify-center p-6">
        <div class="w-full max-w-md text-center">
            <img src="https://i.postimg.cc/8z9X689C/IOU-LOGO-CUSTOM.png" alt="IOU Logo" class="w-32 h-32 mx-auto mb-6 rounded-3xl shadow-[0_0_30px_rgba(57,255,20,0.2)]">
            <h1 class="text-3xl font-black italic mb-8 tracking-tighter">IOU CREDITS</h1>
            
            <div id="loginForm" class="glass p-8 rounded-3xl">
                <input type="email" id="emailInput" placeholder="REAL EMAIL ADDRESS" class="w-full p-4 rounded-xl mb-4 font-bold">
                <input type="password" id="passInput" placeholder="PASSWORD" class="w-full p-4 rounded-xl mb-6 font-bold">
                <button onclick="handleAuth()" class="w-full neo-btn py-4 rounded-xl uppercase tracking-widest">Login / Register</button>
                <p class="text-[10px] mt-4 opacity-40 uppercase font-bold">Verification link sent to new users</p>
            </div>
            
            <div id="verifyPrompt" class="hidden glass p-8 rounded-3xl">
                <h2 class="text-[#39FF14] font-black mb-2">VERIFICATION SENT</h2>
                <p class="text-sm text-white/70 mb-6">Check your inbox. Click the link to activate your account, then return here.</p>
                <button onclick="location.reload()" class="w-full neo-btn py-4 rounded-xl font-black">I'VE VERIFIED</button>
            </div>
        </div>
    </div>

    <div id="appContent" class="hidden flex flex-col h-screen">
        <header class="p-6 flex justify-between items-center border-b border-zinc-900 bg-black">
            <div class="flex items-center gap-3">
                <div id="headerAvatar" class="w-10 h-10 bg-[#39FF14] text-black rounded-full flex items-center justify-center font-black">?</div>
                <div>
                    <p id="headerName" class="font-black text-xs italic uppercase text-white">USER</p>
                    <p id="headerID" class="text-[9px] font-bold opacity-40 tracking-widest">#ID</p>
                </div>
            </div>
            <button onclick="auth.signOut().then(() => location.reload())" class="text-[10px] font-black border border-zinc-800 px-3 py-1 rounded-lg">LOGOUT</button>
        </header>

        <main class="flex-1 overflow-y-auto px-6 pb-32">
            <section id="page-home" class="page active">
                <div id="balanceCard" class="mt-6 p-8 rounded-3xl border-2 border-[#39FF14] bg-black mb-8 shadow-[0_0_20px_rgba(57,255,20,0.05)] transition-all">
                    <p class="text-[10px] font-black uppercase tracking-widest mb-1 opacity-60">Balance</p>
                    <p id="totalDisplay" class="text-5xl font-black tracking-tighter text-white font-mono">$0.00</p>
                </div>

                <div class="grid grid-cols-4 gap-4 mb-10">
                    <button onclick="navTo('addCard')" class="flex flex-col items-center gap-2">
                        <div class="w-14 h-14 glass rounded-2xl flex items-center justify-center text-xl">üí≥</div>
                        <span class="text-[8px] font-black uppercase opacity-60">Deposit</span>
                    </button>
                    <button onclick="navTo('friends')" class="flex flex-col items-center gap-2">
                        <div class="w-14 h-14 glass rounded-2xl flex items-center justify-center text-xl">ü§ù</div>
                        <span class="text-[8px] font-black uppercase opacity-60">Transfer</span>
                    </button>
                    <button onclick="navTo('savings')" class="flex flex-col items-center gap-2">
                        <div class="w-14 h-14 glass rounded-2xl flex items-center justify-center text-xl">üéØ</div>
                        <span class="text-[8px] font-black uppercase opacity-60">Goal</span>
                    </button>
                    <button onclick="navTo('friends')" class="flex flex-col items-center gap-2">
                        <div class="w-14 h-14 glass rounded-2xl flex items-center justify-center text-xl">üí¨</div>
                        <span class="text-[8px] font-black uppercase opacity-60">Chat</span>
                    </button>
                </div>

                <h3 class="text-[10px] font-black uppercase opacity-40 mb-4 tracking-widest">Transaction History</h3>
                <div id="loanList" class="space-y-3"></div>
            </section>

            <section id="page-addCard" class="page">
                <h2 class="text-xl font-black italic mb-6">FUND WALLET</h2>
                <div class="glass p-6 rounded-3xl mb-6">
                    <input type="text" placeholder="CARD NUMBER" class="w-full p-4 rounded-xl mb-4 font-mono">
                    <div class="flex gap-4">
                        <input type="text" placeholder="MM/YY" class="w-1/2 p-4 rounded-xl text-center">
                        <input type="password" placeholder="CVV" class="w-1/2 p-4 rounded-xl text-center">
                    </div>
                </div>
                <button onclick="processDeposit()" class="w-full neo-btn py-5 rounded-2xl uppercase font-black tracking-widest">Authorize</button>
            </section>

            <section id="page-savings" class="page">
                <div class="glass p-8 rounded-3xl mb-8 text-center border-2 border-[#39FF14]">
                    <h2 id="goalName" class="text-xl font-black italic mb-2">TARGET: NONE</h2>
                    <p id="goalAmountDisplay" class="text-2xl font-mono text-white">$0 / $0</p>
                    <div class="w-full bg-zinc-900 h-2 rounded-full mt-6">
                        <div id="goalBar" class="bg-[#39FF14] h-full shadow-[0_0_10px_#39FF14]" style="width: 0%"></div>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <button onclick="setNewGoal()" class="glass py-4 rounded-xl font-black text-[10px] uppercase">Set Goal</button>
                    <button onclick="addSavingsProgress()" class="neo-btn py-4 rounded-xl text-[10px] uppercase">Add Cash</button>
                </div>
            </section>

            <section id="page-friends" class="page">
                <div class="glass p-6 rounded-3xl mb-6 flex gap-2">
                    <input type="text" id="friendIdInput" placeholder="TARGET ID" class="flex-1 p-3 rounded-xl uppercase font-black text-xs">
                    <button onclick="sendFriendRequest()" class="neo-btn px-6 rounded-xl font-black">+</button>
                </div>
                <div id="friendsListContainer" class="space-y-3"></div>
            </section>
        </main>

        <nav class="fixed bottom-0 inset-x-0 p-6 bg-black/95 border-t border-zinc-900 flex justify-around">
            <button onclick="navTo('home')" class="text-2xl">üè†</button>
            <button onclick="navTo('friends')" class="text-2xl">üë•</button>
            <button onclick="navTo('savings')" class="text-2xl">üéØ</button>
        </nav>
    </div>

    <div id="chatModal" class="hidden fixed inset-0 bg-black z-[2000] flex flex-col">
        <header class="p-6 border-b border-zinc-900 flex justify-between items-center">
            <h2 id="chatFriendName" class="font-black italic text-[#39FF14]">SECURE TRANSMISSION</h2>
            <button onclick="closeChat()" class="text-zinc-500 font-black text-xs">CLOSE</button>
        </header>
        <div id="chatMessages" class="flex-1 overflow-y-auto p-6 space-y-4 font-mono text-xs"></div>
        <div class="p-6 bg-black border-t border-zinc-900">
            <div class="flex gap-2">
                <input type="text" id="chatInput" placeholder="Enter message..." class="flex-1 p-4 rounded-xl">
                <button onclick="sendMessage()" class="neo-btn px-6 rounded-xl">SEND</button>
            </div>
        </div>
    </div>

    <script>
        let userData = null;
        let activeChatFriend = null;

        // Splash screen logic
        window.addEventListener('load', () => {
            setTimeout(() => {
                const splash = document.getElementById('splashScreen');
                splash.style.opacity = '0';
                setTimeout(() => splash.style.display = 'none', 700);
            }, 2000);
        });

        async function handleAuth() {
            const email = document.getElementById('emailInput').value.trim();
            const password = document.getElementById('passInput').value;
            if (!email || !password) return;
            try {
                const userCred = await auth.signInWithEmailAndPassword(email, password);
                if (userCred.user.emailVerified) { initializeUser(userCred.user); }
                else { alert("Check your email for the verification link."); auth.signOut(); }
            } catch (error) {
                if (error.code === 'auth/user-not-found') {
                    const newU = await auth.createUserWithEmailAndPassword(email, password);
                    await newU.user.sendEmailVerification();
                    document.getElementById('loginForm').classList.add('hidden');
                    document.getElementById('verifyPrompt').classList.remove('hidden');
                } else { alert(error.message); }
            }
        }

        async function initializeUser(user) {
            const safeEmail = user.email.replace(/\./g, '_');
            const snap = await db.ref(`users/${safeEmail}`).once('value');
            if (!snap.exists()) {
                await db.ref(`users/${safeEmail}`).set({
                    email: user.email,
                    lendID: Math.random().toString(36).substring(2, 7).toUpperCase(),
                    loans: [], friends: [], savings: { goal: 'None', target: 0, current: 0 }
                });
            }
            db.ref(`users/${safeEmail}`).on('value', s => { userData = s.val(); render(); });
            document.getElementById('authSection').classList.add('hidden');
            document.getElementById('appContent').classList.remove('hidden');
        }

        function render() {
            const loans = userData.loans || [];
            const bal = loans.reduce((a, b) => a + b.amount, 0);
            document.getElementById('totalDisplay').innerText = `$${bal.toFixed(2)}`;
            document.getElementById('headerID').innerText = "#" + userData.lendID;
            document.getElementById('headerAvatar').innerText = userData.email[0].toUpperCase();
            document.getElementById('headerName').innerText = userData.email.split('@')[0];
            const s = userData.savings || { goal: 'None', target: 0, current: 0 };
            document.getElementById('goalName').innerText = "TARGET: " + s.goal.toUpperCase();
            document.getElementById('goalAmountDisplay').innerText = `$${s.current.toFixed(2)} / $${s.target.toFixed(2)}`;
            document.getElementById('goalBar').style.width = Math.min(100, s.target > 0 ? (s.current / s.target) * 100 : 0) + '%';
            const list = document.getElementById('loanList'); list.innerHTML = '';
            loans.slice(-5).reverse().forEach(t => {
                list.innerHTML += `<div class="glass p-4 rounded-2xl flex justify-between items-center text-[11px] font-bold">
                    <span class="text-white uppercase">${t.name}</span>
                    <span class="${t.amount >= 0 ? 'text-[#39FF14]' : 'text-red-500'}">${t.amount >= 0 ? '+' : ''}$${t.amount.toFixed(2)}</span>
                </div>`;
            });
            const fList = document.getElementById('friendsListContainer'); fList.innerHTML = '';
            (userData.friends || []).forEach(fID => {
                fList.innerHTML += `<div class="glass p-4 rounded-2xl flex justify-between items-center">
                    <span class="font-mono text-white tracking-widest text-sm">#${fID}</span>
                    <div class="flex gap-2">
                        <button onclick="openChat('${fID}')" class="p-2 border border-[#39FF14]/30 rounded-lg">üí¨</button>
                        <button onclick="payFriend('${fID}')" class="neo-btn px-4 py-1 rounded-lg text-[10px]">PAY</button>
                    </div>
                </div>`;
            });
        }

        function processDeposit() {
            const amt = parseFloat(prompt("Deposit Amount:"));
            if(!amt || amt <= 0) return;
            const loans = userData.loans || []; loans.push({ name: 'CARD DEPOSIT', amount: amt });
            db.ref(`users/${userData.email.replace(/\./g, '_')}/loans`).set(loans);
            alert("Funds Authorized."); navTo('home');
        }

        async function payFriend(fID) {
            const amt = parseFloat(prompt("Transfer Amount:"));
            if(!amt || amt <= 0) return;
            const loans = userData.loans || [];
            if (amt > loans.reduce((a, b) => a + b.amount, 0)) {
                document.getElementById('balanceCard').classList.add('declined');
                alert("DECLINED: Insufficient Balance");
                setTimeout(() => document.getElementById('balanceCard').classList.remove('declined'), 400);
                return;
            }
            const snap = await db.ref('users').once('value'); const all = snap.val();
            let otherPath = null; for(let path in all) if(all[path].lendID === fID) otherPath = path;
            if(otherPath) {
                loans.push({ name: `To #${fID}`, amount: -amt });
                const otherLoans = all[otherPath].loans || []; otherLoans.push({ name: `From #${userData.lendID}`, amount: amt });
                await db.ref(`users/${userData.email.replace(/\./g, '_')}/loans`).set(loans);
                await db.ref(`users/${otherPath}/loans`).set(otherLoans);
                alert("Transfer Complete.");
            }
        }

        function setNewGoal() {
            const n = prompt("Goal Name:"); const t = parseFloat(prompt("Target $:"));
            if(n && t) db.ref(`users/${userData.email.replace(/\./g, '_')}/savings`).set({ goal: n, target: t, current: 0 });
        }

        function addSavingsProgress() {
            const amt = parseFloat(prompt("Amount to Lock:"));
            const loans = userData.loans || [];
            if(amt > loans.reduce((a,b)=>a+b.amount, 0)) return alert("Balance too low.");
            loans.push({ name: 'GOAL TRANSFER', amount: -amt });
            const s = userData.savings; s.current += amt;
            db.ref(`users/${userData.email.replace(/\./g, '_')}`).update({ loans, savings: s });
        }

        function openChat(fID) {
            activeChatFriend = fID; document.getElementById('chatModal').classList.remove('hidden');
            const chatID = [userData.lendID, fID].sort().join('_');
            db.ref(`chats/${chatID}`).on('value', snap => {
                const box = document.getElementById('chatMessages'); box.innerHTML = '';
                (snap.val() || []).forEach(m => {
                    const me = m.sender === userData.lendID;
                    box.innerHTML += `<div class="flex ${me ? 'justify-end' : 'justify-start'}">
                        <div class="${me ? 'bg-[#39FF14] text-black' : 'border border-[#39FF14] text-white'} px-4 py-2 rounded-2xl max-w-[80%] font-bold">${m.text}</div>
                    </div>`;
                });
                box.scrollTop = box.scrollHeight;
            });
        }

        async function sendMessage() {
            const txt = document.getElementById('chatInput').value; if(!txt) return;
            const chatID = [userData.lendID, activeChatFriend].sort().join('_');
            const snap = await db.ref(`chats/${chatID}`).once('value');
            const msgs = snap.val() || []; msgs.push({ sender: userData.lendID, text: txt });
            await db.ref(`chats/${chatID}`).set(msgs); document.getElementById('chatInput').value = '';
        }

        async function sendFriendRequest() {
            const id = document.getElementById('friendIdInput').value.toUpperCase();
            const snap = await db.ref('users').once('value'); const all = snap.val();
            let found = false; for(let path in all) if(all[path].lendID === id) found = true;
            if(found) {
                const f = userData.friends || []; if(!f.includes(id)) f.push(id);
                await db.ref(`users/${userData.email.replace(/\./g, '_')}/friends`).set(f);
                alert("ID Linked.");
            } else { alert("ID Not Found."); }
        }

        function closeChat() { document.getElementById('chatModal').classList.add('hidden'); }
        function navTo(p) { document.querySelectorAll('.page').forEach(pg => pg.classList.remove('active')); document.getElementById('page-'+p).classList.add('active'); }
        auth.onAuthStateChanged(user => { if (user && user.emailVerified) initializeUser(user); });
    </script>
</body>
</html>
